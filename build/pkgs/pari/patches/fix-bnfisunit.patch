From c7a1d35f382e96ddf14694be27a0ca5746880700 Mon Sep 17 00:00:00 2001
From: Karim Belabas <Karim.Belabas@math.u-bordeaux1.fr>
Date: Mon, 9 Sep 2019 17:20:21 +0200
Subject: [PATCH] fix #2164

---
 src/basemath/buch2.c | 3 ++-
 src/test/32/nf       | 3 ++-
 src/test/in/nf       | 4 ++++
 3 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/src/basemath/buch2.c b/src/basemath/buch2.c
index a853d3c48..e31b2278b 100644
--- a/src/basemath/buch2.c
+++ b/src/basemath/buch2.c
@@ -2136,7 +2136,8 @@ bnfisunit(GEN bnf,GEN x)
   for (i = 1; i < RU; i++)
     if (gexpo(gel(emb,i)) > -1) break;
   p1 = imag_i( row_i(logunit,i, 1,RU-1) );
-  p1 = RgV_dotproduct(p1, ex); if (!R1) p1 = gmul2n(p1, -1);
+  p1 = RgV_dotproduct(p1, ex);
+  if (i > R1) p1 = gmul2n(p1, -1);
   p1 = gsub(garg(gel(emb,i),prec), p1);
   /* p1 = arg(the missing root of 1) */
 
diff --git a/src/test/32/nf b/src/test/32/nf
index 16bf83ce3..e6c41f8b5 100644
--- a/src/test/32/nf
+++ b/src/test/32/nf
@@ -494,6 +494,7 @@
 [1, 1/2*x - 1/2]
 Mod(0, x)
 Mod(-6/5, x)
+[0, 2, Mod(0, 2)]~
   ***   at top-level: nfinit([y^3+2,[1,x]])
   ***                 ^---------------------
   *** nfinit: incorrect type in nfbasic_init (t_VEC).
diff --git a/src/test/in/nf b/src/test/in/nf
index 49148123b..94d5165bc 100644
--- a/src/test/in/nf
+++ b/src/test/in/nf
@@ -150,6 +150,10 @@
 nfinit(x, 3)[2]
 nfinit(1/2*x + 3/5, 3)[2]
 
+\\ #2164
+bnf = bnfinit(y^4-y-1);
+bnfisunit(bnf,-y^3+2*y^2-1)
+
 \\ ERRORS: keep at end of file
 
 nfinit([y^3+2,[1,x]])
-- 
2.11.0
