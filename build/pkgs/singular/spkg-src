#!/usr/bin/env bash

if [ "$SAGE_DISTFILES" = "" ]; then
    echo >&2 "SAGE_DISTFILES undefined ... exiting";
    echo >&2 "Maybe run 'sage -sh'?"
    exit 1
fi

if [ $# -ne 0 ]; then
    UPSTREAM_SOURCE_DIRECTORY=`cd "$1" && pwd -P`
    echo "Using tarballs from $UPSTREAM_SOURCE_DIRECTORY instead of downloading"
fi

set -e
umask 0022


SAGEVERSION=`cat $(dirname "$0")/package-version.txt`
VERSION=`echo "$SAGEVERSION" | sed 's/[.]p[0-9]*$//'`
PKGNAME="singular-$VERSION"
DOTVERSION=`echo "$VERSION" | sed 's/p.*//'`
DASHVERSION=`echo "$DOTVERSION" | sed 's/[.]/-/g'`
TARBALL_SRC="singular-${VERSION}.tar.gz"
TARBALL_SHR="singular-${DOTVERSION}-share.tar.gz"
TARGET="$SAGE_DISTFILES/$PKGNAME.tar.bz2"

echo >&2 "Creating tarball $TARGET..."

# Remove old sources and download new
SPKG_ROOT="$SAGE_ROOT/local/var/tmp/singular"

rm -rf "$SPKG_ROOT"
mkdir -p "$SPKG_ROOT/$PKGNAME"
cd "$SPKG_ROOT/$PKGNAME"

URL="http://www.mathematik.uni-kl.de/ftp/pub/Math/Singular/SOURCES/$DASHVERSION"
if [ -z "$UPSTREAM_SOURCE_DIRECTORY" ]; then
    if [ -z "$SINGULAR_GIT" ]; then
        tar xzf <( curl -L "$URL/$TARBALL_SRC" )
    else
        git clone https://github.com/Singular/Sources/ singular.git
        cd singular.git
        sh make_tar.sh
        cd ..
        tar xzf "singular.git/$TARBALL_SRC"
        rm -rf singular.git
    fi
    tar xzf <( curl -L "$URL/$TARBALL_SHR" )
else
    tar xzf "$UPSTREAM_SOURCE_DIRECTORY/$TARBALL_SRC"
    tar xzf "$UPSTREAM_SOURCE_DIRECTORY/$TARBALL_SHR"
fi

# Make everything writable
chmod -R u+w *

### Sanitize upstream shared (documentation) dir
if [ ! -d share/singular ]; then
    echo "Singular directory not in Singular shared tarball, aborting"
    exit 1
fi
mkdir shared
mv "share/singular/singular.idx" shared/
mv "share/info/singular.hlp" shared/
rm -r share


# Sanitize upstream sources
if [ ! -d "singular-$DOTVERSION" ]; then
    echo "singular-$DOTVERSION directory not in Singular tarball, aborting"
    exit 1
fi
mv "singular-$DOTVERSION" latest


### Create actual upstream package

cd "$SPKG_ROOT"
tar c "$PKGNAME" | bzip2 -c --best >"$TARGET"
cd "$SAGE_ROOT"
rm -rf "$SPKG_ROOT"

echo "Now run 'sage --package fix-checksum singular'"
