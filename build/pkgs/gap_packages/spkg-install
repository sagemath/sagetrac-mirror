GAP_DIR="$SAGE_LOCAL/share/gap"
PKG_DIR="$GAP_DIR/pkg"

# Some GAP packages have weird permissions which can prevent us from
# overwriting them
chmod -R u+rwX "$PKG_DIR" || mkdir -p "$PKG_DIR"

cp SPKG.txt "$PKG_DIR"
if [ $? -ne 0 ]; then
    echo >&2 "Error copying SPKG.txt"
    exit 1
fi

cd src/pkg/

# directly install pure GAP packages
#
#    happrime - no longer distributed, partly merged in Hap,
#    cf. https://www.gap-system.org/Packages/packages.html#deppkg
#    (GAP 4.8.6 still had it, but this is gone in 4.10)

sdh_install \
    aclib-* \
    corelg \
    crime-* \
    cryst \
    crystcat \
    design \
    gbnp \
    Hap* \
    HAPcryst \
    hecke-* \
    liealgdb-* \
    liepring-* \
    liering \
    loops \
    MapClass-* \
    polymaking \
    qpa-version-* \
    quagroup \
    repsn \
    sla \
    sonata-* \
    Toric-* \
    "$PKG_DIR"

for p in cohomolo-1.6.7 grape-4.8.1 guava-3.14 nq-2.5.3
do
    echo "Copying package $p"
    cp -r $p "$PKG_DIR"
    if [ $? -ne 0 ]; then
        echo >&2 "Error copying package $p."
        exit 1
    fi
done

# Build GRAPE package
cd "$PKG_DIR"/grape*
rm -rf bin   # added since rebuilding breaks otherwise
./configure "$GAP_DIR"
if [ $? -ne 0 ]; then
    echo >&2 "Error configuring GRAPE package."
    exit 1
fi
$MAKE -j1
if [ $? -ne 0 ]; then
    echo >&2 "Error building GRAPE package."
    exit 1
fi


# Build GUAVA package
cd "$PKG_DIR"/guava-* && ./configure "$GAP_DIR"
if [ $? -ne 0 ]; then
    echo >&2 "Error configuring GUAVA packagae."
    exit 1
fi
$MAKE -j1
if [ $? -ne 0 ]; then
    echo >&2 "Error building GUAVA package."
    exit 1
fi


# Build cohomolo package
cd "$PKG_DIR"/cohomolo-*
#rm -rf bin   # added since rebuilding breaks otherwise
./configure "$GAP_DIR"
if [ $? -ne 0 ]; then
    echo >&2 "Error configuring cohomolo package."
    exit 1
fi
$MAKE -j1
if [ $? -ne 0 ]; then
    echo >&2 "Error building cohomolo package."
    exit 1
fi

# Build nq package
cd "$PKG_DIR"/nq-*
./configure --with-gaproot="$GAP_DIR"
if [ $? -ne 0 ]; then
    echo >&2 "Error configuring nq package."
    exit 1
fi
$MAKE 
if [ $? -ne 0 ]; then
    echo >&2 "Error building nq package."
    exit 1
fi


# Some GAP packages have weird permissions
chmod -R u+rwX "$PKG_DIR"
