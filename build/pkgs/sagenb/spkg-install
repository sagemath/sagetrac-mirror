#!/usr/bin/env bash
# This file is no longer autogenerated.

# don't build on python 3
if [ $(python --version 2>&1 | cut -d' ' -f2 | cut -d'.' -f1) = "3" ]; then
    exit
fi


# Begin boilerplate

CUR=$PWD

die () {
    echo >&2 "$@"
    exit 1
}

[ -n "$SAGE_LOCAL" ] || die 'Error: $SAGE_LOCAL not set. Source sage-env or run this script from `sage -sh`.'

[ -z "$CPATH" ] || CPATH="$CPATH":
[ -z "$LIBRARY_PATH" ] || LIBRARY_PATH="$LIBRARY_PATH":
export CPATH="$CPATH""$SAGE_LOCAL"/include
export LIBRARY_PATH="$LIBRARY_PATH""$SAGE_LOCAL"/lib

# note: the -D_XOPEN_SOURCE=500 is to fix build errors in Twisted 12.1 on
# Solaris. See http://trac.sagemath.org/sage_trac/ticket/11080#comment:314 and
# the subsequent few comments.
export CPPFLAGS="-I$SAGE_LOCAL/include -D_XOPEN_SOURCE=500 $CPPFLAGS"

if [ $SAGE64 = "yes" ]; then
    echo "Building with extra 64-bit flags for MacOS X and Open Solaris."
    if [ -z $CFLAG64 ]; then
        CFLAG64=-m64
    fi
    export CFLAGS="$CFLAGS $CFLAG64"
    export CPPFLAGS="$CPPFLAGS $CFLAG64"
    export CXXFLAGS="$CXXFLAGS $CFLAG64"
    export LDFLAGS="$LDFLAGS $CFLAG64"
fi
# End boilerplate

# delete old sagenb install, if any
rm -rf "${SAGE_LOCAL}/lib/python/site-packages"/sagenb*


# TODO: clean up this crap
# * dependencies should not be part of the sagenb tarball at all
# * get rid of easy_install
# * note that pip currently depends on ssl

# Install dependencies
for PKG in $(cat src/install_order); do
    easy_install -Z -H None "src/$PKG"
    if [ $? -ne 0 ]; then
        echo >&2 "Error: Installing $PKG failed."
        exit 1
    fi
done


# Install sagenb into site-packages
PKG=$(ls -1 src | GREP_OPTIONS= grep sagenb-)
easy_install -Z -H None "src/$PKG"
if [ $? -ne 0 ]; then
    echo >&2 "Error: Installing SageNB failed."
    exit 1
fi


# let sagenb use mathjax spkg
cd "${SAGE_LOCAL}/lib/python/site-packages"/sagenb-*.egg/sagenb/data
if [ $? -ne 0 ]; then
    echo >&2 "Error: Cannot find SageNB data directory."
    exit 1
fi
# the following line can be removed once sagenb does not ship mathjax anymore.
rm -rf mathjax
ln -s ../../../../../../share/mathjax/ mathjax
