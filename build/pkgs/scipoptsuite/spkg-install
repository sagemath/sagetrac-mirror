#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting"
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

SPKGDIR=`pwd`

cd src

SRC=`pwd`

CFLAGS="$CFLAGS -I$SAGE_LOCAL/include -L$SAGE_LOCAL/lib"

if [ "x$SAGE_DEBUG" = "xyes" ]; then
    CFLAGS="$CFLAGS -O0 -ggdb"
fi

ARCH=`uname -m`
if [ x"$ARCH" = x"i386" -o x"$ARCH" = x"i486" -o x"$ARCH" = x"i586" -o x"$ARCH" = x"i686" ]; then
  ARCH="x86"
fi

OS=`uname -s | tr '[:upper:]' '[:lower:]'`

SOPLEX_TARBALL=`find . -name "soplex-*.tgz"`

if [ -z $SOPLEX_TARBALL ]; then
    echo "Could not find SoPlex tarball in the scipoptsuite tarball.  Something is wrong."
    exit 1;
fi

# Remove existing directories
find . -name "soplex-*" -type d | xargs rm -rf

tar xvfz $SOPLEX_TARBALL;

if [ $? -ne 0 ]; then
    echo "Error unpacking SOPLEX."
    exit 1
fi

SOPLEX_DIR=`find . -name "soplex-*" -type d`
SOPLEX_DIR=`basename $SOPLEX_DIR`
SOPLEX_VERSION=`echo "$SOPLEX_DIR" | sed -e "s/.*-//"`

SCIP_TARBALL=`find . -name "scip-*.tgz"`

if [ -z $SCIP_TARBALL ]; then
    echo "Could not find SCIP tarball in the scipoptsuite tarball.  Something is wrong."
    exit 1;
fi

# Remove existing directories
find . -name "scip-*" -type d | xargs rm -rf

tar xfz $SCIP_TARBALL;

if [ $? -ne 0 ]; then
    echo "Error unpacking SCIP."
    exit 1
fi

SCIP_DIR=`find . -name "scip-*" -type d`
SCIP_DIR=`basename $SCIP_DIR`
SCIP_VERSION=`echo "$SCIP_DIR" | sed -e "s/.*-//"`


# Apply patch to SCIP.
(cd $SCIP_DIR && patch -p1 < $SPKGDIR/patches/scip-libdep.patch)
if [ $? -ne 0 ]; then
    echo "Error patching SCIP."
    exit 1
fi


echo "Compiling SoPlex"

if [ `uname` = 'Darwin' ] ; then
    SHAREDLIBEXT="dylib"
    arg_LIBBUILDFLAGS=LIBBUILDFLAGS="$LDFLAGS -dynamiclib -undefined suppress -flat_namespace -install_name $SAGE_LOCAL/lib/libsoplex-$SOPLEX_VERSION.$OS.$ARCH.gnu.opt.$SHAREDLIBEXT -lgmp -lz"
else
    SHAREDLIBEXT="so"
fi

cd $SRC/$SOPLEX_DIR
## The Makefile in soplex 2.2.1 forgets to add the library dependencies
## "-lgmp -lz", causing the link to fail on Mac OS X.
LIBBUILDFLAGS="-lgmp -lz -lreadline"
make VERBOSE=true OPT=opt ZLIB=true READLINE=true SHARED=true USRCFLAGS="$CFLAGS" USRLDFLAGS="$LDFLAGS" "$arg_LIBBUILDFLAGS" SHAREDLIBEXT="$SHAREDLIBEXT"  INSTALLDIR="$SAGE_LOCAL" install

if [ $? -ne 0 ]; then
    echo "Error building SOPLEX."
    exit 1
fi

# Soplex 'make install' installs 3 copies of the library instead of making symlinks. Overwrite.
# Use -PR to copy symlink as symlink
cp -PR lib/*.$SHAREDLIBEXT "$SAGE_LOCAL"/lib

echo "Preparing SCIP ./lib symbolic links"

# this is necessary, otherwise scip asks for directories (see the "touch" commands below)
cd $SRC/$SCIP_DIR
mkdir lib
cd lib

ln -sv $SRC/$SOPLEX_DIR/lib/libsoplex-$SOPLEX_VERSION.$OS.$ARCH.gnu.opt.$SHAREDLIBEXT libsoplex.$OS.$ARCH.gnu.opt.$SHAREDLIBEXT
ln -sv $SRC/$SOPLEX_DIR/src/ spxinc
touch libsoplex.$OS.$ARCH.gnu.opt.a

echo "Compiling SCIP"

cd $SRC/$SCIP_DIR
# for clp add the option LPS=clp
## added -rpath.  Abusing LIBBUILD_o is of course a hack. 
make OPT=opt VERBOSE=true SHARED=true ZIMPL=false GMP=true ZLIB=true READLINE=true USRCFLAGS="$CFLAGS" USRLDFLAGS="$LDFLAGS" \
 LIBBUILD_o="-Wl,-rpath,$SAGE_LOCAL/lib -lgmp -lz -lreadline -o " SHAREDLIBEXT="$SHAREDLIBEXT" INSTALLDIR="$SAGE_LOCAL" LINKRPATH="" install
if [ $? -ne 0 ]; then
    echo "Error building/installing SCIP."
    exit 1
fi

if [ `uname` = 'Darwin' ]; then 
    # Adjust install_name on Mac OS (check with otool -L).
    # (Could instead change the Makefile to use -install_name option to linker)
    for a in liblpispx libnlpi.cppad libscip libobjscip ; do
	install_name_tool -id "$SAGE_LOCAL/lib/$a-$SCIP_VERSION.$OS.$ARCH.gnu.opt.$SHAREDLIBEXT" $SAGE_LOCAL/lib/$a-$SCIP_VERSION.$OS.$ARCH.gnu.opt.$SHAREDLIBEXT
	if [ $? -ne 0 ]; then
	    echo "Error adjusting install_name for SCIP libraries"
	    exit 1
	fi
    done
    # Finally, change the install name of libscip's dependencies.
    for a in libscip; do
	for b in liblpispx libnlpi.cppad ; do 
	    install_name_tool -change lib/$b-$SCIP_VERSION.$OS.$ARCH.gnu.opt.$SHAREDLIBEXT $SAGE_LOCAL/lib/$b-$SCIP_VERSION.$OS.$ARCH.gnu.opt.$SHAREDLIBEXT $SAGE_LOCAL/lib/$a-$SCIP_VERSION.$OS.$ARCH.gnu.opt.$SHAREDLIBEXT
	done
    done
fi


echo "finished building SCIP with SoPlex"
