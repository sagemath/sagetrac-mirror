#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting"
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

SRC=`pwd`

CFLAGS="$CFLAGS -I$SAGE_LOCAL/include -L$SAGE_LOCAL/lib"

if [ "x$SAGE_DEBUG" = "xyes" ]; then
    CFLAGS="$CFLAGS -O0 -ggdb"
fi

ARCH=`uname -m`
if [ x"$ARCH" = x"i386" -o x"$ARCH" = x"i486" -o x"$ARCH" = x"i586" -o x"$ARCH" = x"i686" ]; then
  ARCH="x86"
fi

OS=`uname -s | tr '[:upper:]' '[:lower:]'`

SOPLEX_TARBALL=`find $SAGE_ROOT/upstream -name "soplex-*.tgz"`

if [ -z $SOPLEX_TARBALL ]; then
    echo "Could not find SoPlex tarball. Please download it from http://scip.zib.de/ and place it in $SAGE_ROOT/upstream"
    exit 1;
fi

rm -rf ./soplex-*
tar xvfz $SOPLEX_TARBALL;

if [ $? -ne 0 ]; then
    echo "Error unpacking SOPLEX."
    exit 1
fi

SOPLEX_DIR=`find . -name "soplex-*" -type d`
SOPLEX_DIR=`basename $SOPLEX_DIR`
SOPLEX_VERSION=`echo "$SOPLEX_DIR" | sed -e "s/.*-//"`

SCIP_TARBALL=`find $SAGE_ROOT/upstream -name "scip-*.tgz"`

if [ -z $SCIP_TARBALL ]; then
    echo "Could not find SCIP tarball. Please download it from http://scip.zib.de/ and place it in $SAGE_ROOT/upstream"
    exit 1;
fi

rm -rf ./scip-*
tar xfz $SCIP_TARBALL;

if [ $? -ne 0 ]; then
    echo "Error unpacking SCIP."
    exit 1
fi

SCIP_DIR=`find . -name "scip-*" -type d`
SCIP_DIR=`basename $SCIP_DIR`
SCIP_VERSION=`echo "$SCIP_DIR" | sed -e "s/.*-//"`

echo "Compiling SoPlex"

# it's really necessary to say zlib=false, otherwise i got "unknown
# symbol: gzwrite" when loading scip is there no zlib in sage?!

cd $SRC/$SOPLEX_DIR
make OPT=opt ZLIB=false READLINE=false SHARED=true USRCFLAGS="$CFLAGS"

if [ $? -ne 0 ]; then
    echo "Error building SOPLEX."
    exit 1
fi

cp lib/*.so "$SAGE_LOCAL"/lib

echo "Preparing SCIP ./lib symbolic links"

# this is necessary, otherwise scip asks for directories (see the "touch" commands below)
cd $SRC/$SCIP_DIR
mkdir lib
cd lib

ln -sv $SRC/$SOPLEX_DIR/lib/libsoplex-$SOPLEX_VERSION.$OS.$ARCH.gnu.opt.so libsoplex.$OS.$ARCH.gnu.opt.so
ln -sv $SRC/$SOPLEX_DIR/src/ spxinc
touch libsoplex.$OS.$ARCH.gnu.opt.a

echo "Compiling SCIP"

cd $SRC/$SCIP_DIR
# for clp add the option LPS=clp
make OPT=opt SHARED=true ZIMPL=false GMP=true ZLIB=false READLINE=false USRCFLAGS="$CFLAGS"

if [ $? -ne 0 ]; then
    echo "Error building SCIP"
    exit 1
fi

if [ ! -d $SAGE_LOCAL/include/scip ]; then
   mkdir $SAGE_LOCAL/include/scip
fi

cp lib/libscip*.so "$SAGE_LOCAL"/lib
cp lib/liblpispx*.so "$SAGE_LOCAL"/lib
cp lib/libnlpi*.so "$SAGE_LOCAL"/lib
cp lib/libobjscip*.so "$SAGE_LOCAL"/lib

cp -r src/scip/*.h "$SAGE_LOCAL"/include/scip/

if [ ! -d $SAGE_LOCAL/include/scip/blockmemshell ]; then
   mkdir $SAGE_LOCAL/include/scip/blockmemshell
fi

cp -r src/blockmemshell/*.h "$SAGE_LOCAL"/include/scip/blockmemshell


if [ ! -d $SAGE_LOCAL/include/scip/nlpi ]; then
   mkdir $SAGE_LOCAL/include/scip/nlpi
fi

cp -r src/nlpi/*.h "$SAGE_LOCAL"/include/scip/nlpi


echo "finished building SCIP with SoPlex"
