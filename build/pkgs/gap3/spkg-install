#!/usr/bin/env bash

# Installation script for gap3; based on the installation script for gap4.

###########################################
## SETUP
###########################################

# if [ -z "$SAGE_LOCAL" ]; then
#     echo >&2 "SAGE_LOCAL undefined ... exiting"
#     echo >&2 "Maybe run 'sage --sh'?"
#     exit 1
# fi

PACKAGE_SHORTNAME=gap3
VERSION=`cat package-version.txt`
GAP3_DIR="gap-$VERSION"
INSTALL_DIR="$SAGE_LOCAL/$PACKAGE_SHORTNAME/$GAP3_DIR"

echo "spkg-install is using"
echo "VERSION = $VERSION"
echo "GAP3_DIR = $GAP3_DIR"
echo "INSTALL_DIR = $INSTALL_DIR"

###########################################
## MODIFY UPSTREAM
###########################################

cd src

echo "Applying patches..."
for patch in ../patches/*.patch; do
    [ -r "$patch" ] || continue  # Skip non-existing or non-readable patches
    patch -p1 <"$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        exit 1
    fi
done

# FIXME: this should be fixed upstream
echo "Correcting file permissions..."
chmod 755 bin/gap.mac
chmod 755 bin/gap.macx86

###########################################
## INSTALLATION
###########################################

echo "Installing (copying) files..."
mkdir -p "$INSTALL_DIR" &&
cp -R * "$INSTALL_DIR"
if [[ $? -ne 0 ]]; then
    echo >&2 "Error installing (copying) $PACKAGE_SHORTNAME files."
    exit 1
fi

echo "Creating symlink to new $PACKAGE_SHORTNAME installation..."
rm -f "$SAGE_LOCAL/$PACKAGE_SHORTNAME/latest"
ln -s "$GAP3_DIR" "$SAGE_LOCAL/$PACKAGE_SHORTNAME/latest"

echo "Copying GAP3 startup script..."
rm -f "$SAGE_LOCAL/bin/gap3"
cp bin/gap.sh "$SAGE_LOCAL/bin/gap3"
if [[ $? -ne 0 ]]; then
    echo >&2 "Error copying customized $PACKAGE_SHORTNAME startup script."
    exit 1
fi

if [[ "$SAGE_SPKG_INSTALL_DOCS" = yes ]]; then
    echo "Now copying GAP3's (HTML) documentation..."
    DOC_DIR="$SAGE_LOCAL/share/doc/$PACKAGE_SHORTNAME"
    mkdir -p "$DOC_DIR" &&
    cp -R htm "$DOC_DIR"
    if [[ $? -ne 0 ]]; then
        echo >&2 "Error copying $PACKAGE_SHORTNAME's HTML documentation."
        exit 1
    fi
fi
