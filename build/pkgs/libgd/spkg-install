# Critical to get rid of old versions, since they will break the install, since
# at some point one of the libraries accidently links against what's in SAGE_LOCAL,
# instead of what is in the build directory!
rm "$SAGE_LOCAL"/lib/libgd.*

cd src

export CFLAGS="-g $CFLAGS"

if [ "$UNAME" = "CYGWIN" ]; then
    # Compiling with vpx support creates a broken library in some cases
    # because the vpx package itself is broken on some older Cygwin versions;
    # we don't need this feature so safer to just disable
    # https://trac.sagemath.org/ticket/27970
    LIBGD_CONFIGURE="--without-vpx $LIBGD_CONFIGURE"
fi

# We explicitly disable X and fontconfig support, since (1) X is not a SAGE dependency,
# and (2) the gd build fails on a lot of OS X PPC machines when X is enabled.
sdh_configure --without-jpeg --without-xpm --without-x --without-fontconfig \
              --with-zlib="$SAGE_LOCAL" --with-freetype="$SAGE_LOCAL" \
              $LIBGD_CONFIGURE
sdh_make
sdh_make_install
