#!/usr/bin/env bash
# Handle options of the src/bin/sage script that pertain to SAGE_ROOT or sage-the-distribution.

usage() {
    echo
    ####  1.......................26..................................................78
    ####  |.....................--.|...................................................|
    echo "Sage-the-distribution options:"
    echo "  -optional           -- list all optional packages that can be installed"
    echo "  -experimental       -- list all experimental packages that can be installed"
    echo "  -info [packages]    -- print the SPKG.txt or SPKG.rst of the given packages,"
    echo "                         and some additional information."
    echo "  -i [packages]       -- install the given Sage packages"
    echo "  -upgrade [version]  -- download, build and install the given version. Here,"
    echo "                         'version' is a git branch or tag name. Useful values"
    echo "                         are 'master' (the current development version, this"
    echo "                         is the default) or a version number like '5.13'."
}

usage_advanced() {
    echo
    ####  1.......................26..................................................78
    ####  |.....................--.|...................................................|
    echo "Installing packages and upgrading:"
    echo "  -package [args]     -- call the new package manager with given arguments."
    echo "                         Run without arguments for package-specific help."
    echo "  -experimental       -- list all experimental packages that can be installed"
    echo "  -f [opts] [packages]-- shortcut for -i -f: force build of the given Sage"
    echo "                         packages"
    echo "  -i [opts] [packages]-- install the given Sage packages.  Options:"
    echo "                           -c -- run the packages' test suites"
    echo "                           -d -- only download, do not install packages"
    echo "                           -f -- force build: install the packages even"
    echo "                                 if they are already installed"
    echo "                           -s -- do not delete the temporary build directories"
    echo "                                 after a successful build"
    echo "                           -y -- reply yes to prompts about experimental"
    echo "                                 and old-style packages; warning: there"
    echo "                                 is no guarantee that these packages will"
    echo "                                 build correctly; use at your own risk"
    echo "                           -n -- reply no to prompts about experimental"
    echo "                                 and old-style packages"
    echo "  -p [opts] [packages]-- install the given Sage packages, without dependency"
    echo "                         checking. Options are the same as for the -i command."
    echo "  --location          -- if needed, fix paths to make Sage relocatable"
    echo "  -optional           -- list all optional packages that can be installed"
    echo "  -standard           -- list all standard packages that can be installed"
    echo "  -installed          -- list all installed packages"
    echo "  -upgrade [version]  -- download, build and install the given version. Here,"
    echo "                         'version' is a git branch or tag name. Useful values"
    echo "                         are 'master' (the current development version, this"
    echo "                         is the default) or a version number like '5.13'."

    echo
    ####  1.......................26..................................................78
    ####  |.....................--.|...................................................|
    echo "Making Sage packages or distributions:"
    echo "  -sdist              -- build a source distribution of Sage"
    echo "  -fix-pkg-checksums  -- fix the checksums from build/pkgs directories from "
    echo "                         the packages located in upstream/"
}

if [ "$1" = '-h' -o "$1" = '-?' -o "$1" = '-help' -o "$1" = '--help' ]; then
    usage
    exit 0
fi
if [ "$1" = "-advanced" -o "$1" = "--advanced" ]; then
    usage_advanced
    exit 0
fi

if [ "$1" = '-package' -o "$1" = "--package" ]; then
    shift
    exec sage-package $@
fi

if [ "$1" = '-optional' -o "$1" = "--optional" ]; then
    shift
    exec sage-list-packages optional $@
fi

if [ "$1" = '-experimental' -o "$1" = "--experimental" ]; then
    shift
    exec sage-list-packages experimental $@
fi

if [ "$1" = '-standard' -o "$1" = "--standard" ]; then
    shift
    exec sage-list-packages standard $@
fi

if [ "$1" = '-installed' -o "$1" = "--installed" ]; then
    shift
    exec sage-list-packages all --installed-only $@
fi

if [ "$1" = '-p' ]; then
    echo "Error: Installing old-style SPKGs is no longer supported."
    exit 1
fi

if [ "$1" = '-info' -o "$1" = '--info' ]; then
    shift
    for PKG in "$@"
    do
        sage-spkg --info "$PKG" || exit $?
    done
    exit 0
fi

if [ "$1" = '-fix-pkg-checksums' -o "$1" = '--fix-pkg-checksums' ]; then
    shift
    exec sage-fix-pkg-checksums "$@"
fi

echo "Error: Unknown option: $1"
exit 1
